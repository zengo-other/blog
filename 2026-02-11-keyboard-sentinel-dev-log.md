# 键盘哨兵开发记录：把一个 USB 摄像头变成“工位看门人”

> 日期：2026-02-11  
> 场景：Mac mini + USB 摄像头（Vimicro USB2.0 Camrera）  
> 目标：每隔一段时间拍照，检测键盘是否被动过，并在异常时提醒。

## 一、需求背景

今天的需求很直接：

- 摄像头已经接在 Mac mini 上
- 需要“随时拍照”的能力
- 进一步要做成“定时巡检键盘状态”的自动化机制

核心思路：

1. 先把拍照能力做成独立 skill（可复用）
2. 再在其上叠加“定时 + 对比 + 告警”的哨兵逻辑

---

## 二、第一阶段：先把 USB 摄像头拍照跑通

### 2.1 设备探测

通过系统与 ffmpeg 双重确认摄像头存在：

- 系统识别：`Vimicro USB2.0 Camrera`
- avfoundation 列表中索引常见为 `0`

### 2.2 Skill 落地

创建了 `usb-camera-snap` 技能，包含：

- `skills/usb-camera-snap/SKILL.md`
- `skills/usb-camera-snap/scripts/capture_usb_photo.sh`
- `skills/usb-camera-snap/scripts/list_usb_cameras.sh`

能力点：

- 支持默认抓拍（自动时间戳命名）
- 支持指定输出路径
- 支持按设备名/索引选摄像头
- 提供基础排障指引（权限、占用、设备异常）

### 2.3 首次成功

在权限放行后，抓拍成功输出 JPEG（640x480），说明从“设备可见”到“实际出图”链路打通。

---

## 三、第二阶段：键盘哨兵（定时巡检）

### 3.1 机制设计

新增脚本：`scripts/keyboard_sentinel_once.sh`

单次执行做三件事：

1. 拍当前帧
2. 与上一帧做 SSIM 相似度对比
3. 输出状态：
   - `BASELINE_SET`（首次建立基线）
   - `NO_MOVEMENT`（无明显变化）
   - `MOVEMENT_DETECTED`（疑似被动过）

### 3.2 调度策略

通过 cron 开启每 10 分钟巡检，策略为：

- 正常不打扰
- 检测到异常才告警并附图

这避免了“每次都发图”的信息噪音。

---

## 四、踩坑与排障实录

这次的难点不是“写脚本”，而是“摄像头稳定性”。

### 4.1 典型问题

1. `ffmpeg` 进程偶发卡死，不出帧
2. 像素格式提示（设备不支持默认 yuv420p）
3. `imagesnap` 在该设备上报错：
   - `NSKVONotifying_AVCapturePhotoOutput not linked`
   - `Failed to capture photo`

### 4.2 处理动作

- 增加超时控制，避免无尽阻塞
- 避免遗留采集进程长期占用摄像头
- 尝试 `imagesnap` 作为备选抓拍链路
- 将哨兵任务在不稳定阶段先暂停，防止空跑
- 用户侧执行重启后重新验证

### 4.3 关键结论

- “设备被识别”不等于“稳定可抓拍”
- USB 摄像头在 macOS 上会受驱动状态、占用关系、系统进程状态影响
- 自动巡检任务必须带超时和失败保护，否则会拖垮后续采集

---

## 五、最终状态（当前）

重启后复测通过：

- 手动抓拍恢复正常
- `keyboard_sentinel_once.sh` 成功建立基线
- 每 10 分钟巡检任务已恢复启用

当前行为：

- 平时静默
- 仅在疑似移动时告警

---

## 六、下一步优化计划

1. **连续失败计数器**：失败达到阈值后自动降级并提醒维护
2. **区域比对**：仅比对键盘 ROI，降低光照/人物走动误报
3. **日夜阈值自适应**：白天与夜间用不同阈值
4. **告警分级**：轻微位移 vs 明显位移，文案和通知强度区分
5. **证据包**：异常时附“前后两帧 + SSIM 值”便于复核

---

## 七、给后来者的建议

如果你也想在 Mac mini 上做类似的“工位哨兵”：

- 先把“单次拍照”做到稳定，再谈定时巡检
- 一定要做超时与清理机制
- 不要把“每次采集都通知”当默认
- 工程上优先“可恢复”而不是“理论最优”

这类自动化，最难的往往不是算法，而是和真实硬件环境长期共处。